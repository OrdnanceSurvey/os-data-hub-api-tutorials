<!DOCTYPE html>
<html>
<head>
    <title>OS Vector Tile API | Asset Capture</title>
    <meta charset="utf-8" />
    <meta http-equiv="x-ua-compatible" content="ie=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <link rel="icon" type="image/x-icon" href="/os-favicon.ico" />
    <link rel="stylesheet" href="https://labs.os.uk/public/os-api-branding/v0.2.0/os-api-branding.css" />
    <link rel="stylesheet" href="https://api.tiles.mapbox.com/mapbox-gl-js/v1.13.0/mapbox-gl.css" />
    <style>
        body { margin:0; padding:0; }
        #map { position:absolute; top:0; bottom:0; width:100%; }
    </style>
</head>
<body>

    <style>
        .map-overlay {
            font: 12px/20px 'Helvetica Neue', Arial, Helvetica, sans-serif;
            position: absolute;
            top: 0;
            left: 0;
            padding: 10px;
        }
        .map-overlay-inner {
            background-color: #fff;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.20);
            border-radius: 3px;
            padding: 10px;
            width: 240px;
        }
        .map-overlay-inner h3 {
            margin: 0 0 10px;
        }
    </style>

<div id="map"></div>
<div class="map-overlay">
    <div class="map-overlay-inner">
        <h3>OS Vector Tile API: Asset Capture</h3>
        <div>Click to add a feature.<br>Click again to remove.</div>
        <pre></pre>
        <div id="download-link"></div>
    </div>
</div>

<script src="https://labs.os.uk/public/os-api-branding/v0.2.0/os-api-branding.js"></script>
<script src="https://api.tiles.mapbox.com/mapbox-gl-js/v1.13.0/mapbox-gl.js"></script>
<script src="https://npmcdn.com/@turf/turf/turf.min.js"></script>
<script>

var apiKey = 'SrUGRuBNJ9UgRoI6cdJ0WIzbYJ8n1P91';

var serviceUrl = 'https://api.os.uk/maps/vector/v1/vts';

// Initialize the map object.
var map = new mapboxgl.Map({
    container: 'map',
    minZoom: 6,
    maxZoom: 18,
    style: serviceUrl + '/resources/styles?key=' + apiKey,
    center: [ -1.382027, 51.001369 ],
    zoom: 18,
    transformRequest: url => {
        return {
            url: url + '&srs=3857'
        }
    }
});

map.dragRotate.disable(); // Disable map rotation using right click + drag.
map.touchZoomRotate.disableRotation(); // Disable map rotation using touch rotation gesture.

// Add navigation control (excluding compass button) to the map.
map.addControl(new mapboxgl.NavigationControl({
    showCompass: false
}));

var geojson = turf.featureCollection([]);

var qryLayers = [
    'OS/TopographicArea_1/Building/1',
    'OS/TopographicArea_1/Multi Surface'
];

var toidArray = [];

// Generate UUID v4 (RFC4122 compliant).
var uuid = function() {
    var uuid = "", i, random;
    for( i = 0; i < 32; i++ ) {
        random = Math.random() * 16 | 0;
        if( i == 8 || i == 12 || i == 16 || i == 20 )
            uuid += "-";
        uuid += (i == 12 ? 4 : (i == 16 ? (random & 3 | 8) : random)).toString(16);
    }
    return uuid;
};

map.on('load', function() {
    map.addSource("combine", { type: "geojson", data: geojson });

    map.addLayer({
        "id": "combine-fill",
        "type": "fill",
        "source": "combine",
        "paint": {
            "fill-color": "#c00",
            "fill-opacity": 0.2
        }
    });
    map.addLayer({
        "id": "combine-line",
        "type": "line",
        "source": "combine",
        "paint": {
            "line-color": "#c00",
            "line-width": 2
        }
    });

    map.on('click', function(e) {
        var features = map.queryRenderedFeatures(e.point, { layers: qryLayers });
        if(! features.length )
            return;

        for( var i = 0; i < features.length; i++ ) {
            var toid = features[i].properties.TOID,
                j = toidArray.indexOf(toid);

            if( j === -1 )
                toidArray.push(toid);
            else
                toidArray.splice(j, 1);

            break;
        }

        var filter = [ "in", "TOID" ];
        for( var i in toidArray ) {
            filter.push(toidArray[i]);
        }

        var ftArray = map.queryRenderedFeatures({ filter: filter });

        if(! ftArray.length ) {
            reset();
        }
        else {
            geojson = turf.getType(ftArray[0].geometry)=== 'Polygon' ?
                turf.polygon(ftArray[0].geometry.coordinates) :
                turf.multiPolygon(ftArray[0].geometry.coordinates);

            geojson = turf.flatten(geojson);

            for( var i in ftArray ) {
                var _geojson = turf.getType(ftArray[i].geometry)=== 'Polygon' ?
                    turf.polygon(ftArray[i].geometry.coordinates) :
                    turf.multiPolygon(ftArray[i].geometry.coordinates);

                for( var j = 0; j < turf.flatten(_geojson).features.length; j++ ) {
                    geojson.features.push(turf.flatten(_geojson).features[j]);
                }
            }

            geojson = turf.buffer(turf.combine(geojson), 0);

            var _uuid = uuid();

            geojson.features[0].properties = {
                id: _uuid,
                refToTopo: toidArray,
                calcArea: turf.area(geojson)
            };

            // document.getElementsByTagName("pre")[0].innerText = JSON.stringify(geojson, null, 2);
            document.getElementById("download-link").innerHTML = `<a href="data:${"text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(geojson))}" download="${_uuid}.geojson">Download GeoJSON</a>`;
        }

        // console.log(geojson);

        map.getSource("combine").setData(geojson);
    });

    map.on('mousemove', function(e) {
        var features = map.queryRenderedFeatures(e.point, { layers: qryLayers });
        map.getCanvas().style.cursor = (features.length) ? 'pointer' : '';
    });
});

function reset(redraw = false) {
    geojson = turf.featureCollection([]);

    // document.getElementsByTagName("pre")[0].innerText = '';
    document.getElementById("download-link").innerHTML = '';

    if( redraw ) {
        toidArray = [];
        map.getSource("combine").setData(geojson);
    }
}

</script>

</body>
</html>
